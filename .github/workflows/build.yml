name: Kernel Build Process
permissions:
  contents: write
  actions: write

on:
  workflow_call:
    inputs:
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string
      sub_level:
        required: true
        type: string
      os_patch_level:
        required: true
        type: string
      variant:
        required: false
        type: string
      ksu_variant:
        required: true
        type: string
      ksu_commit:
        required: false
        type: string
      build_bypass:
        required: true
        type: boolean
      use_zram:
        required: false
        type: boolean
        default: true

jobs:
  build-gki:
    name: "${{ inputs.kernel_version }}.${{ inputs.sub_level }}-${{ inputs.android_version }}-${{ inputs.os_patch_level }}-${{ matrix.build_type }}-${{ inputs.ksu_variant }}"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: true
      matrix:
        build_type: >-
          ${{
            fromJSON(
              inputs.variant == 'vTomsonek' && '["vTomsonek"]' ||
              inputs.variant == 'TheWildJames' && '["TheWildJames"]' ||
              inputs.variant == 'TheWildJamesTest' && '["TheWildJamesTest"]' ||
              inputs.variant == 'MarionKernel' && '["MarionKernel"]' ||
              inputs.variant == 'Hakan' && '["Hakan"]' ||
              (inputs.build_bypass && '["Normal","Bypass"]' || '["Normal"]')
            )
          }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Build Summary
      run: |
        echo "========================================"
        echo "       Kernel Build Summary"
        echo "========================================"
        echo "Android Version : ${{ inputs.android_version }}"
        echo "Kernel Version  : ${{ inputs.kernel_version }}"
        echo "Sub Level       : ${{ inputs.sub_level }}"
        echo "Patch Level     : ${{ inputs.os_patch_level }}"
        echo "Build Type      : ${{ matrix.build_type }}"
        echo "KSU Variant     : ${{ inputs.ksu_variant }}"
        echo "KSU Commit      : ${{ inputs.ksu_commit || 'Default' }}"
        echo "SUSFS Enabled   : ${{ inputs.susfs_enabled }}"
        echo "Variant         : ${{ inputs.variant || 'Standard' }}"
        echo "========================================"

    - name: Free Disk Space
      if: true
      uses: endersonmenezes/free-disk-space@v3  # Use @main for latest, @v3 for stable
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
        remove_packages_one_command: true
        remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"
        rm_cmd: "rmz"  # Use 'rmz' for faster deletion (default: 'rm')
        rmz_version: "3.1.1"  # Required when rm_cmd is 'rmz'
        testing: false

    - name: Setup Build Environment
      run: |
        CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
        KERNEL_ROOT="$GITHUB_WORKSPACE/$CONFIG"
        mkdir -p "$KERNEL_ROOT"

        cat >> $GITHUB_ENV << EOF
        DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig
        CONFIG=$CONFIG
        KERNEL_ROOT=$KERNEL_ROOT
        SUSFS4KSU=$GITHUB_WORKSPACE/susfs4ksu
        KERNEL_PATCHES=$GITHUB_WORKSPACE/kernel_patches
        ANYKERNEL3=$GITHUB_WORKSPACE/AnyKernel3
        REPO=$GITHUB_WORKSPACE/git-repo/repo
        EOF
        
        mkdir -p "$GITHUB_WORKSPACE/git-repo"
        curl -L https://storage.googleapis.com/git-repo-downloads/repo -o "$GITHUB_WORKSPACE/git-repo/repo"
        chmod 0755 "$GITHUB_WORKSPACE/git-repo/repo"
        echo "$GITHUB_WORKSPACE/git-repo" >> "$GITHUB_PATH"

    - name: Clone AnyKernel3 and Other Dependencies
      run: |
        ANYKERNEL_BRANCH="gki-2.0"
        git clone https://github.com/WildKernels/AnyKernel3.git -b "$ANYKERNEL_BRANCH"
        rm -rf AnyKernel3/.git
        git clone https://github.com/WildKernels/kernel_patches.git wild_kernel_patches
        # Merge our local patches with Wild patches
        cp -r kernel_patches/* wild_kernel_patches/ 2>/dev/null || true
        rm -rf kernel_patches
        mv wild_kernel_patches kernel_patches
        git clone https://github.com/ShirkNeko/SukiSU_patch.git

    - name: Initialize and Sync Kernel Source
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        FORMATTED_BRANCH="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}"

        repo init -u https://android.googlesource.com/kernel/manifest -b common-${FORMATTED_BRANCH} --repo-rev=v2.16 --depth=1

        REMOTE_BRANCH=$(git ls-remote https://android.googlesource.com/kernel/common ${FORMATTED_BRANCH})
        DEFAULT_MANIFEST_PATH=.repo/manifests/default.xml
        if grep -q deprecated <<< $REMOTE_BRANCH; then
          sed -i "s/\"${FORMATTED_BRANCH}\"/\"deprecated\/${FORMATTED_BRANCH}\"/g" $DEFAULT_MANIFEST_PATH
        fi

        repo --trace sync -c -j$(nproc --all) --fail-fast --no-tags --force-sync --no-clone-bundle

    - name: Extract Sublevel and Set File Name
      run: |
        ACTUAL_SUBLEVEL="${{ inputs.sub_level }}"
        if [[ -f "$KERNEL_ROOT/common/Makefile" ]]; then
          EXTRACTED=$(grep '^SUBLEVEL = ' "$KERNEL_ROOT/common/Makefile" | awk '{print $3}')
          [[ -n "$EXTRACTED" ]] && ACTUAL_SUBLEVEL="$EXTRACTED"
        fi

        ARTIFACT_BASE="${{ inputs.kernel_version }}.$ACTUAL_SUBLEVEL-${{ inputs.android_version }}-${{ inputs.os_patch_level }}-${{ matrix.build_type }}"
        echo "ACTUAL_SUBLEVEL=$ACTUAL_SUBLEVEL" >> $GITHUB_ENV
        echo "ARTIFACT_BASE=$ARTIFACT_BASE" >> $GITHUB_ENV
        echo "FILE_NAME=$ARTIFACT_BASE" >> $GITHUB_ENV

    - name: Apply glibc 2.38 Compatibility Fix
      run: |
        # Use ACTUAL_SUBLEVEL for LTS builds, otherwise use the input sub_level
        if [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.10" && $ACTUAL_SUBLEVEL -le 186 ]] || 
           [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.15" && $ACTUAL_SUBLEVEL -le 119 ]] || 
           [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "5.15" && $ACTUAL_SUBLEVEL -le 110 ]] || 
           [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "6.1" && $ACTUAL_SUBLEVEL -le 43 ]]; then
          GLIBC_VERSION=$(ldd --version 2>/dev/null | head -n 1 | awk '{print $NF}') 
          if [ "$(printf '%s\n' "2.38" "$GLIBC_VERSION" | sort -V | head -n1)" = "2.38" ]; then 
            cd "$KERNEL_ROOT/common"
            sed -i '/\$(Q)\$(MAKE) -C \$(SUBCMD_SRC) OUTPUT=\$(abspath \$(dir \$@))\/ \$(abspath \$@)/s//$(Q)$(MAKE) -C $(SUBCMD_SRC) EXTRA_CFLAGS="$(CFLAGS)" OUTPUT=$(abspath $(dir $@))\/ $(abspath $@)/' tools/bpf/resolve_btfids/Makefile 2>/dev/null || true
            if [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.10" && $ACTUAL_SUBLEVEL -le 186 ]] || 
               [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.15" && $ACTUAL_SUBLEVEL -le 119 ]] || 
               [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "5.15" && $ACTUAL_SUBLEVEL -le 110 ]]; then
              sed -i '/char \*buf = NULL;/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++) {/for (i = 0; subcommands[i]; i++) {/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i '/if (subcommands) {/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++)/for (i = 0; subcommands[i]; i++)/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
            fi
          fi
        fi 

    - name: Fix Less Than 6.6.50 Builds
      if: inputs.android_version == 'android15' && inputs.kernel_version == '6.6'
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        if ! grep -qxF '#include <trace/hooks/fs.h>' ./fs/namespace.c; then
            sed -i '/#include <trace\/hooks\/blk.h>/a #include <trace\/hooks\/fs.h>' ./fs/namespace.c
        fi

    - name: Apply ptrace patch for older kernels
      if: false && fromJSON(inputs.kernel_version) < 5.16
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        patch -p1 -F 3 < "$KERNEL_PATCHES/gki_ptrace.patch"

    - name: Add KernelSU Variant
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        case "${{ inputs.ksu_variant }}" in
          WKSU)
            if [[ -n "${{ inputs.ksu_commit }}" ]]; then
              curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s "${{ inputs.ksu_commit }}"
            else
              curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s wild
            fi

            # Patch WildKSU extras.c for AVC spoof coordination with SUSFS
            EXTRAS_FILE="$KERNEL_ROOT/Wild_KSU/kernel/extras.c"
            if [ -f "$EXTRAS_FILE" ]; then
              echo "Patching WildKSU extras.c for AVC spoof coordination..."

              # Add ksu_avc_spoof_active export after disable_spoof declaration
              sed -i '/^static atomic_t disable_spoof/a\\n// Exported for SUSFS coordination - when true, SUSFS defers AVC handling\nbool ksu_avc_spoof_active = false;\nEXPORT_SYMBOL(ksu_avc_spoof_active);' "$EXTRAS_FILE"

              # Set ksu_avc_spoof_active = true in enable function
              sed -i '/atomic_set(\&disable_spoof, 0);/a\	ksu_avc_spoof_active = true;' "$EXTRAS_FILE"

              # Set ksu_avc_spoof_active = false in disable function
              sed -i '/atomic_set(\&disable_spoof, 1);/a\	ksu_avc_spoof_active = false;' "$EXTRAS_FILE"

              # Remove #ifndef CONFIG_KSU_SUSFS guards so AVC works with SUSFS
              sed -i 's/#ifndef CONFIG_KSU_SUSFS/\/\/ SUSFS guard removed for coordination/g' "$EXTRAS_FILE"
              sed -i 's/#endif \/\/ CONFIG_KSU_SUSFS/\/\/ end SUSFS guard/g' "$EXTRAS_FILE"

              echo "WildKSU extras.c patched"
            fi

            # Patch WildKSU ksud.c to always call ksu_avc_spoof_late_init
            KSUD_FILE="$KERNEL_ROOT/Wild_KSU/kernel/ksud.c"
            if [ -f "$KSUD_FILE" ]; then
              echo "Patching WildKSU ksud.c to enable AVC spoof with SUSFS..."

              # Add unconditional call after track_throne(true)
              # The original guarded call will be skipped when SUSFS enabled
              sed -i '/track_throne(true);/a\    ksu_avc_spoof_late_init();' "$KSUD_FILE"

              # Add ksu_handle_sys_newfstatat stub for SUSFS compatibility
              # SUSFS patch calls this in fs/stat.c - WildKSU has ksu_handle_vfs_fstat but not this
              if ! grep -q "ksu_handle_sys_newfstatat" "$KSUD_FILE"; then
                awk '/void ksu_handle_vfs_fstat/{found=1} found && /^}/{print; print "void ksu_handle_sys_newfstatat(int fd, loff_t *kstat_size_ptr) { }"; found=0; next}1' "$KSUD_FILE" > "$KSUD_FILE.tmp" && mv "$KSUD_FILE.tmp" "$KSUD_FILE"
              fi
              echo "WildKSU ksud.c patched with AVC init and newfstatat stub"
            fi

            # Patch WildKSU Kbuild to guard KPROBES check against clean targets
            # The check fires during 'make mrproper' when no config is loaded
            KBUILD_FILE="$KERNEL_ROOT/Wild_KSU/kernel/Kbuild"
            if [ -f "$KBUILD_FILE" ]; then
              echo "Patching WildKSU Kbuild to guard KPROBES check..."

              # Replace the unconditional $(error ...) with a guarded version
              # Only check KPROBES when actually building (not cleaning)
              sed -i 's/\$(error KSU requires Kprobes; enable it (defconfig))/$(if $(filter-out mrproper clean distclean,$(MAKECMDGOALS)),$(error KSU requires Kprobes; enable it (defconfig)))/' "$KBUILD_FILE"

              echo "WildKSU Kbuild patched - KPROBES check now guarded"
            fi
            ;;
          Next)
            if [[ -n "${{ inputs.ksu_commit }}" ]]; then
              curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/stable/kernel/setup.sh" | bash -s "${{ inputs.ksu_commit }}"
            else
              curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/dev/kernel/setup.sh" | bash -s dev
            fi
            ;;
          KSU)
            if [[ -n "${{ inputs.ksu_commit }}" ]]; then
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s "${{ inputs.ksu_commit }}"
            else
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
            fi
            ;;
          RKSU)
            if [[ -n "${{ inputs.ksu_commit }}" ]]; then
              curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s "${{ inputs.ksu_commit }}"
            else
              curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s main
            fi
            ;;
          ReSuki)
            # ReSukiSU - Pin to latest stable tag for reliability
            curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash -
            cd "$KERNEL_ROOT/KernelSU"
            LATEST_TAG=$(git describe --abbrev=0 --tags 2>/dev/null || echo "main")
            if [[ "$LATEST_TAG" != "main" ]]; then
              git checkout "$LATEST_TAG"
              echo "ReSukiSU: Checked out tag $LATEST_TAG"
            else
              echo "ReSukiSU: Using main branch (no tags found)"
            fi
            ;;
        esac

    - name: Clone & Apply SUSFS Patches for KernelSU Variants
      run: |
        SUSFS_BRANCH="gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}"
        git clone https://github.com/Enginex0/susfs4ksu.git -b "$SUSFS_BRANCH"

        case "${{ inputs.ksu_variant }}" in
          WKSU)
            SUSFS_VERSION="2.0.0"

            # Add KSU_SUSFS_UNICODE_FILTER Kconfig option to Wild_KSU (not present by default)
            # Wild_KSU installs to $KERNEL_ROOT/Wild_KSU, not KernelSU
            cd "$KERNEL_ROOT/Wild_KSU"
            if [ -f "$KERNEL_PATCHES/wild/add_unicode_filter_kconfig.patch" ]; then
              echo "Adding KSU_SUSFS_UNICODE_FILTER to Wild_KSU Kconfig..."
              if ! patch -p1 --fuzz=3 < "$KERNEL_PATCHES/wild/add_unicode_filter_kconfig.patch"; then
                echo "ERROR: Unicode filter Kconfig patch failed!"
                echo "=== Current Kconfig tail ==="
                tail -30 kernel/Kconfig
                exit 1
              fi
              if ! grep -q "KSU_SUSFS_UNICODE_FILTER" kernel/Kconfig; then
                echo "ERROR: KSU_SUSFS_UNICODE_FILTER not found in Kconfig after patching!"
                exit 1
              fi
              echo "SUCCESS: Unicode filter Kconfig option added"
            fi

            cd "$KERNEL_ROOT/common"
            cp "$SUSFS4KSU/kernel_patches/fs/"* "$KERNEL_ROOT/common/fs/"
            cp "$SUSFS4KSU/kernel_patches/include/linux/"* "$KERNEL_ROOT/common/include/linux/"
            cp $SUSFS4KSU/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch ./
            patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true

            # Apply Unicode filter hooks (SUSFS built-in, boot-safe implementation)
            if [ -f "$SUSFS4KSU/kernel_patches/fs/51_add_susfs_unicode_filter_hooks.patch" ]; then
              cp "$SUSFS4KSU/kernel_patches/fs/51_add_susfs_unicode_filter_hooks.patch" ./
              patch -p1 --fuzz=3 < 51_add_susfs_unicode_filter_hooks.patch || echo "Warning: Unicode filter hooks patch had issues"
            fi

            if [[ "${{ inputs.android_version }}" == "android12" && "${{ inputs.kernel_version }}" == "5.10" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -le 209 ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi 
              if [[ "$ACTUAL_SUBLEVEL" -le 117 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a12-5.10/fdinfo.c.patch ./
                patch -p1 < fdinfo.c.patch
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 43 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a12-5.10/base.c.patch ./
                patch -p1 < base.c.patch
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.10" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -le 107 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a13-5.10/fdinfo.c.patch ./
                patch -p1 < fdinfo.c.patch
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 209 && "${{ inputs.os_patch_level }}" != "2024-05" ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.15" ]]; then
              if [ "$ACTUAL_SUBLEVEL" -le 41 ]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a13-5.15/namespace.c.patch ./
                patch -p1 < namespace.c.patch
              fi
              if [ "$ACTUAL_SUBLEVEL" -le 41 ]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a13-5.15/fdinfo.c.patch ./
                patch -p1 < fdinfo.c.patch
              fi
              if [ "$ACTUAL_SUBLEVEL" -le 41 ]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a13-5.15/open.c.patch ./
                patch -p1 < open.c.patch
              fi
              if [ "$ACTUAL_SUBLEVEL" -le 41 ]; then
                sed -i 's|is_i_uid_not_allowed(i_uid_into_mnt(i_user_ns(inode), inode).val)))|is_i_uid_not_allowed(inode->i_uid.val)))|g' fs/susfs.c
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 148 && "${{ inputs.os_patch_level }}" != "2024-05" ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "5.15" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -le 148 && "${{ inputs.os_patch_level }}" != "2024-05" ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "6.1" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -ge 145 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a14-6.1/base.c.patch ./
                patch -p1 < base.c.patch
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 75 && "${{ inputs.os_patch_level }}" != "2024-05" ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android15" && "${{ inputs.kernel_version }}" == "6.6" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -ge 98 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a15-6.6/base.c.patch ./
                patch -p1 < base.c.patch
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 58 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a15-6.6/task_mmu.c.patch ./
                patch -p1 < task_mmu.c.patch
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android16" && "${{ inputs.kernel_version }}" == "6.12" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -le 9999 ]]; then
                echo "Nothing to fix!"
              fi
            fi
            ;;
          Next)
            SUSFS_VERSION="2.0.0"
            cd "$KERNEL_ROOT/KernelSU-Next"
            echo "patching kernel"
            cp $SUSFS4KSU/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            patch -p1 < 10_enable_susfs_for_ksu.patch || true
            echo "patching susfs fix patches"
            cp "$KERNEL_PATCHES/next/susfs_fix_patches/v${SUSFS_VERSION}/"*.patch ./
            echo "fixing Makefile/kbuild"
            patch -p1 < fix_Makefile.patch
            echo "fixing allowlist.c"
            patch -p1 < fix_allowlist.c.patch
            echo "fixing apk_sign.c"
            patch -p1 < fix_apk_sign.c.patch
            echo "fixing kernel_umount.c"
            patch -p1 < fix_kernel_umount.c.patch
            echo "fixing ksu.c"
            patch -p1 < fix_ksu.c.patch
            echo "fixing ksud.c"
            patch -p1 < fix_ksud.c.patch
            echo "fixing selinux.c"
            patch -p1 < fix_selinux.c.patch
            echo "fixing setuid_hook.c"
            patch -p1 < fix_setuid_hook.c.patch
            echo "fixing sucompat.c"
            patch -p1 < fix_sucompat.c.patch
            echo "fixing supercalls.c"
            patch -p1 < fix_supercalls.c.patch
            echo "overwriting hook mode"
            patch -p1 < overwrite_hook_mode.patch
            echo "patching ksu_toolkit"
            patch -p1 < ksu_toolkit.patch

            cd "$KERNEL_ROOT/common"
            cp "$SUSFS4KSU/kernel_patches/fs/"* "$KERNEL_ROOT/common/fs/"
            cp "$SUSFS4KSU/kernel_patches/include/linux/"* "$KERNEL_ROOT/common/include/linux/"
            cp $SUSFS4KSU/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch ./
            patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true

            # Apply Unicode filter hooks (SUSFS built-in, boot-safe implementation)
            if [ -f "$SUSFS4KSU/kernel_patches/fs/51_add_susfs_unicode_filter_hooks.patch" ]; then
              cp "$SUSFS4KSU/kernel_patches/fs/51_add_susfs_unicode_filter_hooks.patch" ./
              patch -p1 --fuzz=3 < 51_add_susfs_unicode_filter_hooks.patch || echo "Warning: Unicode filter hooks patch had issues"
            fi

            if [[ "${{ inputs.android_version }}" == "android12" && "${{ inputs.kernel_version }}" == "5.10" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -le 209 ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 117 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a12-5.10/fdinfo.c.patch ./
                patch -p1 < fdinfo.c.patch
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 43 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a12-5.10/base.c.patch ./
                patch -p1 < base.c.patch
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.10" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -le 107 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a13-5.10/fdinfo.c.patch ./
                patch -p1 < fdinfo.c.patch
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 209 && "${{ inputs.os_patch_level }}" != "2024-05" ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.15" ]]; then
              if [ "$ACTUAL_SUBLEVEL" -le 41 ]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a13-5.15/namespace.c.patch ./
                patch -p1 < namespace.c.patch
              fi
              if [ "$ACTUAL_SUBLEVEL" -le 41 ]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a13-5.15/fdinfo.c.patch ./
                patch -p1 < fdinfo.c.patch
              fi
              if [ "$ACTUAL_SUBLEVEL" -le 41 ]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a13-5.15/open.c.patch ./
                patch -p1 < open.c.patch
              fi
              if [ "$ACTUAL_SUBLEVEL" -le 41 ]; then
                sed -i 's|is_i_uid_not_allowed(i_uid_into_mnt(i_user_ns(inode), inode).val)))|is_i_uid_not_allowed(inode->i_uid.val)))|g' fs/susfs.c
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 148 && "${{ inputs.os_patch_level }}" != "2024-05" ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "5.15" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -le 148 && "${{ inputs.os_patch_level }}" != "2024-05" ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "6.1" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -ge 145 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a14-6.1/base.c.patch ./
                patch -p1 < base.c.patch
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 75 && "${{ inputs.os_patch_level }}" != "2024-05" ]]; then
                sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android15" && "${{ inputs.kernel_version }}" == "6.6" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -ge 98 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a15-6.6/base.c.patch ./
                patch -p1 < base.c.patch
              fi
              if [[ "$ACTUAL_SUBLEVEL" -le 58 ]]; then
                cp $KERNEL_PATCHES/wild/susfs_fix_patches/v${SUSFS_VERSION}/a15-6.6/task_mmu.c.patch ./
                patch -p1 < task_mmu.c.patch
              fi
            fi

            if [[ "${{ inputs.android_version }}" == "android16" && "${{ inputs.kernel_version }}" == "6.12" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -le 9999 ]]; then
                echo "Nothing to fix!"
              fi
            fi
            ;;
          KSU)
            SUSFS_VERSION="2.0.0"
            cd "$KERNEL_ROOT/KernelSU"
            cp "$SUSFS4KSU/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" .
            patch -p1 < 10_enable_susfs_for_ksu.patch
            ;;
          ReSuki)
            # ReSukiSU SUSFS Integration - STRICT MODE (no fallbacks, patches must apply cleanly)
            SUSFS_VERSION="2.0.0"
            echo "=== Applying SUSFS to ReSukiSU (STRICT) ==="

            # Step 1: Apply ReSukiSU-specific SUSFS patch (complete with all symbol definitions)
            cd "$KERNEL_ROOT/KernelSU"
            SUSFS_PATCH="$SUSFS4KSU/kernel_patches/KernelSU/10_enable_susfs_for_resukisu.patch"
            if [ ! -f "$SUSFS_PATCH" ]; then
              echo "ERROR: ReSukiSU SUSFS patch not found: $SUSFS_PATCH"
              exit 1
            fi
            cp "$SUSFS_PATCH" .
            echo "Applying ReSukiSU SUSFS integration patch..."
            patch -p1 --fuzz=3 < 10_enable_susfs_for_resukisu.patch
            PATCH_EXIT=$?
            if [ $PATCH_EXIT -ne 0 ]; then
              echo "ERROR: ReSukiSU SUSFS patch failed with exit code $PATCH_EXIT"
              echo "=== Patch rejects ==="
              find . -name "*.rej" -exec cat {} \;
              exit 1
            fi

            # Verify critical changes
            echo "Verifying patch applied correctly..."
            grep -q "config KSU_SUSFS" kernel/Kconfig || { echo "FAIL: Kconfig missing KSU_SUSFS"; exit 1; }
            grep -q "susfs_init" kernel/ksu.c || { echo "FAIL: ksu.c missing susfs_init"; exit 1; }
            grep -q "ksu_init_rc_hook" kernel/ksud.c || { echo "FAIL: ksud.c missing ksu_init_rc_hook"; exit 1; }
            grep -q "ksu_handle_execveat" kernel/sucompat.c || { echo "FAIL: sucompat.c missing ksu_handle_execveat"; exit 1; }
            echo "SUCCESS: All ReSukiSU SUSFS integrations verified"

            # Step 2: Copy SUSFS kernel files
            cd "$KERNEL_ROOT/common"
            cp "$SUSFS4KSU/kernel_patches/fs/susfs.c" fs/
            cp "$SUSFS4KSU/kernel_patches/include/linux/susfs.h" include/linux/
            cp "$SUSFS4KSU/kernel_patches/include/linux/susfs_def.h" include/linux/
            echo "SUCCESS: SUSFS kernel files copied"

            # Step 3: Apply main SUSFS kernel patch
            SUSFS_KERNEL_PATCH="$SUSFS4KSU/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch"
            if [ ! -f "$SUSFS_KERNEL_PATCH" ]; then
              echo "ERROR: Main SUSFS kernel patch not found: $SUSFS_KERNEL_PATCH"
              exit 1
            fi
            cp "$SUSFS_KERNEL_PATCH" ./
            echo "Applying main SUSFS kernel patch..."
            patch -p1 --fuzz=3 < "50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch"
            PATCH_EXIT=$?
            if [ $PATCH_EXIT -ne 0 ]; then
              echo "ERROR: Main SUSFS kernel patch failed"
              find . -name "*.rej" -exec cat {} \;
              exit 1
            fi
            echo "SUCCESS: Main SUSFS kernel patch applied"

            # Step 4: Apply Unicode filter hooks (SUSFS built-in, boot-safe implementation)
            if [ -f "$SUSFS4KSU/kernel_patches/fs/51_add_susfs_unicode_filter_hooks.patch" ]; then
              cp "$SUSFS4KSU/kernel_patches/fs/51_add_susfs_unicode_filter_hooks.patch" ./
              echo "Applying Unicode filter hooks patch..."
              patch -p1 --fuzz=3 < 51_add_susfs_unicode_filter_hooks.patch || echo "Warning: Unicode filter hooks patch had issues"
            fi

            # Step 5: Version-specific kernel fixes (legitimate sed for kernel quirks)
            if [[ "${{ inputs.android_version }}" == "android12" && "${{ inputs.kernel_version }}" == "5.10" ]]; then
              if [[ "$ACTUAL_SUBLEVEL" -le 209 ]]; then
                # Fix task_mmu.c pad printing issue in older kernels
                if grep -q "goto show_pad;" ./fs/proc/task_mmu.c; then
                  sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
                  echo "Applied task_mmu.c fix for sublevel <= 209"
                fi
              fi
            fi

            echo "=== ReSukiSU SUSFS integration complete (ALL VERIFIED) ==="
            ;;
        esac

    - name: Integrate NoMount VFS Hiding
      if: ${{ inputs.kernel_version == '6.6' || inputs.kernel_version == '6.1' || inputs.kernel_version == '5.15' || inputs.kernel_version == '5.10' }}
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Integrating NoMount ==="

        # Clone nomount-vfs repo (single source of truth for all NoMount patches)
        git clone --depth 1 https://github.com/Enginex0/nomount-vfs.git "$GITHUB_WORKSPACE/nomount-vfs"
        NOMOUNT_VFS="$GITHUB_WORKSPACE/nomount-vfs"

        cd common

        # Select appropriate patch based on kernel version
        if [[ "${{ inputs.kernel_version }}" == "6.6" || "${{ inputs.kernel_version }}" == "6.1" || "${{ inputs.kernel_version }}" == "5.15" ]]; then
          NOMOUNT_PATCH="$NOMOUNT_VFS/patches/nomount-kernel-5.15-6.6.patch"
        else
          NOMOUNT_PATCH="$NOMOUNT_VFS/patches/nomount-kernel-5.10.patch"
        fi

        echo "Applying NoMount patch: $NOMOUNT_PATCH"

        # Apply patch with fuzz to handle minor line number differences
        # Allow failures for files that conflict with SUSFS (we'll fix manually)
        patch -p1 --fuzz=3 < "$NOMOUNT_PATCH" || true

        # Check if core NoMount files were created (uses obfuscated names: vfs_dcache)
        if [[ -f "fs/vfs_dcache.c" && -f "include/linux/vfs_dcache.h" ]]; then
          echo "SUCCESS: NoMount core files created (fs/vfs_dcache.c, include/linux/vfs_dcache.h)"
        else
          echo "ERROR: NoMount core files missing!"
          ls -la fs/vfs_dcache.c include/linux/vfs_dcache.h 2>&1 || true
          exit 1
        fi

        # Fix fs/namei.c include if not applied (patch uses vfs_dcache.h)
        if ! grep -q "vfs_dcache.h" fs/namei.c; then
          echo "Adding NoMount include to fs/namei.c"
          sed -i '/#include <linux\/uaccess.h>/a #ifdef CONFIG_FS_DCACHE_PREFETCH' fs/namei.c
          sed -i '/#ifdef CONFIG_FS_DCACHE_PREFETCH/a #include <linux\/vfs_dcache.h>' fs/namei.c
          sed -i '/#include <linux\/vfs_dcache.h>/a #endif' fs/namei.c
        fi

        # Apply vfs_readlink hook using semantic injection script
        # (Replaces sed-based approach for better cross-version compatibility)
        echo "Applying namei.c vfs_readlink hook via semantic injection script..."
        chmod +x "$NOMOUNT_VFS/patches/inject-namei-hooks.sh"
        bash "$NOMOUNT_VFS/patches/inject-namei-hooks.sh" fs/namei.c || echo "WARNING: namei injection had issues"

        # Apply readdir.c hooks using semantic injection script
        # (readdir.c removed from patch - always use injection script for cross-version compatibility)
        echo "Applying readdir.c hooks via semantic injection script..."
        chmod +x "$NOMOUNT_VFS/patches/inject-readdir-hooks.sh"
        bash "$NOMOUNT_VFS/patches/inject-readdir-hooks.sh" fs/readdir.c || echo "WARNING: readdir injection had issues"

        # Kconfig and Makefile are already handled by the patch (CONFIG_FS_DCACHE_PREFETCH, vfs_dcache.o)
        # Only add if missing (shouldn't happen if patch applied correctly)
        if ! grep -q "CONFIG_FS_DCACHE_PREFETCH" fs/Kconfig; then
          echo "Adding CONFIG_FS_DCACHE_PREFETCH to fs/Kconfig (fallback)"
          echo "" >> fs/Kconfig
          echo "config FS_DCACHE_PREFETCH" >> fs/Kconfig
          echo "	bool \"VFS dcache prefetch support\"" >> fs/Kconfig
          echo "	default y" >> fs/Kconfig
        fi

        if ! grep -q "vfs_dcache.o" fs/Makefile; then
          echo "Adding vfs_dcache.o to fs/Makefile (fallback)"
          echo 'obj-$(CONFIG_FS_DCACHE_PREFETCH) += vfs_dcache.o' >> fs/Makefile
        fi

        # Fix fs/stat.c stat spoofing hook (CRITICAL for detection bypass)
        # This often fails to apply due to SUSFS already modifying generic_fillattr()
        if ! grep -q "nomount_spoof_stat" fs/stat.c; then
          echo "WARNING: NoMount stat spoofing hook not in fs/stat.c - applying manual fix"
          # Add include for vfs_dcache.h if not present
          if ! grep -q "linux/vfs_dcache.h" fs/stat.c; then
            UACCESS_LINE=$(grep -n "include <linux/uaccess.h>" fs/stat.c | head -1 | cut -d: -f1)
            [ -n "$UACCESS_LINE" ] && sed -i "${UACCESS_LINE}a #ifdef CONFIG_FS_DCACHE_PREFETCH" fs/stat.c
            [ -n "$UACCESS_LINE" ] && sed -i "$((UACCESS_LINE+1))a #include <linux/vfs_dcache.h>" fs/stat.c
            [ -n "$UACCESS_LINE" ] && sed -i "$((UACCESS_LINE+2))a #endif" fs/stat.c
            echo "Added vfs_dcache.h include to fs/stat.c"
          fi
          # Add stat spoofing hook after stat->ino assignment
          STAT_INO_LINE=$(grep -n "stat->ino = inode->i_ino;" fs/stat.c | head -1 | cut -d: -f1)
          if [ -n "$STAT_INO_LINE" ]; then
            sed -i "${STAT_INO_LINE}a\\ " fs/stat.c
            sed -i "$((STAT_INO_LINE+1))a #ifdef CONFIG_FS_DCACHE_PREFETCH" fs/stat.c
            sed -i "$((STAT_INO_LINE+2))a \\	/* Spoof stat values for VFS-redirected files */" fs/stat.c
            sed -i "$((STAT_INO_LINE+3))a \\	if (nomount_is_injected_file(inode))" fs/stat.c
            sed -i "$((STAT_INO_LINE+4))a \\		nomount_spoof_stat(inode, stat);" fs/stat.c
            sed -i "$((STAT_INO_LINE+5))a #endif" fs/stat.c
            echo "Added stat spoofing hook to fs/stat.c"
          fi
          # Verify the fix was applied
          if grep -q "nomount_spoof_stat" fs/stat.c; then
            echo "SUCCESS: fs/stat.c stat spoofing hook applied"
          else
            echo "ERROR: Failed to apply fs/stat.c stat spoofing hook"
            exit 1
          fi
        else
          echo "SUCCESS: NoMount stat spoofing hook already present in fs/stat.c"
        fi

        # Apply statfs.c hooks using semantic injection script
        # (statfs.c removed from patch - use injection script for cross-version compatibility)
        echo "Applying statfs.c hooks via semantic injection script..."
        chmod +x "$NOMOUNT_VFS/patches/inject-statfs-hooks.sh"
        bash "$NOMOUNT_VFS/patches/inject-statfs-hooks.sh" fs/statfs.c || echo "WARNING: statfs injection had issues (non-fatal)"

        # Apply xattr.c hooks using semantic injection script
        # (Hooks __vfs_getxattr for SELinux context spoofing)
        echo "Applying xattr.c hooks via semantic injection script..."
        chmod +x "$NOMOUNT_VFS/patches/inject-xattr-hooks.sh"
        bash "$NOMOUNT_VFS/patches/inject-xattr-hooks.sh" fs/xattr.c || echo "WARNING: xattr injection had issues (non-fatal)"

        # Apply proc_namespace.c hooks for /proc/mounts filtering
        echo "Applying proc_namespace.c hooks via semantic injection script..."
        chmod +x "$NOMOUNT_VFS/patches/inject-procmounts-hooks.sh"
        bash "$NOMOUNT_VFS/patches/inject-procmounts-hooks.sh" fs/proc_namespace.c || true

        # Apply stat.c hooks for fstat/fstatat spoofing
        echo "Applying stat.c hooks via semantic injection script..."
        chmod +x "$NOMOUNT_VFS/patches/inject-stat-hooks.sh"
        bash "$NOMOUNT_VFS/patches/inject-stat-hooks.sh" fs/stat.c || true

        # Apply task_mmu.c hooks for /proc/PID/maps filtering
        echo "Applying task_mmu.c hooks via semantic injection script..."
        chmod +x "$NOMOUNT_VFS/patches/inject-maps-hooks.sh"
        bash "$NOMOUNT_VFS/patches/inject-maps-hooks.sh" fs/proc/task_mmu.c || true

        # Add CONFIG_FS_DCACHE_PREFETCH=y to defconfig
        echo "CONFIG_FS_DCACHE_PREFETCH=y" >> arch/arm64/configs/gki_defconfig

        # Clean up any .rej files
        find . -name "*.rej" -delete

        echo "=== NoMount integration complete ==="

    - name: Apply Hide Stuff Patch
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Applying 69_hide_stuff.patch ==="
        HIDE_PATCH="$GITHUB_WORKSPACE/SukiSU_patch/69_hide_stuff.patch"
        if [ -f "$HIDE_PATCH" ]; then
          cp "$HIDE_PATCH" ./
          echo "Applying 69_hide_stuff.patch (LineageOS/JIT maps hiding)..."
          patch -p1 -F 3 < 69_hide_stuff.patch || echo "Warning: 69_hide_stuff.patch had issues (may already be applied or kernel version mismatch)"
          echo "=== Hide stuff patch complete ==="
        else
          echo "WARNING: 69_hide_stuff.patch not found at $HIDE_PATCH"
        fi

    - name: Upgrade LZ4 to v1.10.0 with ARM64 NEON
      if: ${{ inputs.use_zram }}
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Upgrading LZ4 to v1.10.0 ==="

        # Remove old LZ4 library files
        rm -f lib/lz4/lz4_compress.c lib/lz4/lz4_decompress.c lib/lz4/lz4defs.h lib/lz4/lz4hc_compress.c

        # Copy new LZ4 v1.10.0 library with ARM64 NEON optimization
        cp -r $GITHUB_WORKSPACE/zram/lz4/* ./lib/lz4/
        cp -r $GITHUB_WORKSPACE/zram/include/linux/* ./include/linux/

        # Apply LZ4 kernel integration patch for this kernel version
        if [ -f "$GITHUB_WORKSPACE/zram/${{ inputs.kernel_version }}/lz4_1.10.0.patch" ]; then
          cp "$GITHUB_WORKSPACE/zram/${{ inputs.kernel_version }}/lz4_1.10.0.patch" ./
          patch -p1 -F 3 --fuzz=5 < lz4_1.10.0.patch || true
          echo "LZ4 v1.10.0 patch applied for kernel ${{ inputs.kernel_version }}"
        else
          echo "WARNING: No LZ4 patch found for kernel ${{ inputs.kernel_version }}"
        fi

        # Verify LZ4 NEON assembly exists
        if [ -f "lib/lz4/lz4armv8/lz4armv8.S" ]; then
          echo "SUCCESS: LZ4 ARM64 NEON assembly present"
        else
          echo "WARNING: LZ4 ARM64 NEON assembly missing"
        fi

        echo "=== LZ4 upgrade complete ==="

    - name: Add LZ4K/LZ4KD Compression Support
      if: ${{ inputs.use_zram }}
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Adding LZ4K/LZ4KD compression support ==="

        SUKISU_PATCH="$GITHUB_WORKSPACE/SukiSU_patch"

        # Copy LZ4K source files from SukiSU_patch
        if [ -d "$SUKISU_PATCH/other/zram/lz4k" ]; then
          cp -r "$SUKISU_PATCH/other/zram/lz4k/include/linux/"* ./include/linux/
          cp -r "$SUKISU_PATCH/other/zram/lz4k/lib/"* ./lib/
          cp -r "$SUKISU_PATCH/other/zram/lz4k/crypto/"* ./crypto/
          cp -r "$SUKISU_PATCH/other/zram/lz4k_oplus" ./lib/
          echo "SUCCESS: LZ4K/LZ4KD source files copied"
        else
          echo "WARNING: LZ4K source directory not found"
        fi

        # Apply LZ4KD patch for this kernel version
        KERNEL_VER="${{ inputs.kernel_version }}"
        if [ -f "$SUKISU_PATCH/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch" ]; then
          cp "$SUKISU_PATCH/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch" ./
          patch -p1 -F 3 < lz4kd.patch || true
          echo "SUCCESS: LZ4KD patch applied for kernel $KERNEL_VER"
        else
          echo "WARNING: No LZ4KD patch found for kernel $KERNEL_VER"
        fi

        # Apply LZ4K_OPLUS patch for this kernel version
        if [ -f "$SUKISU_PATCH/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" ]; then
          cp "$SUKISU_PATCH/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" ./
          patch -p1 -F 3 < lz4k_oplus.patch || true
          echo "SUCCESS: LZ4K_OPLUS patch applied for kernel $KERNEL_VER"
        else
          echo "WARNING: No LZ4K_OPLUS patch found for kernel $KERNEL_VER"
        fi

        echo "=== LZ4K/LZ4KD support complete ==="

    - name: Apply KernelSU-Next Fixes
      if: ${{ inputs.ksu_variant == 'Next' }}
      working-directory: ${{ env.KERNEL_ROOT }}/KernelSU-Next
      run: |
        echo "=== Applying KernelSU-Next fixes from fork ==="

        # Apply additional Next fixes from our repo
        for patch in $GITHUB_WORKSPACE/next-patch/*.patch; do
          if [ -f "$patch" ]; then
            echo "Applying: $(basename $patch)"
            patch -p1 -F 3 < "$patch" || true
          fi
        done

        echo "=== KernelSU-Next fixes complete ==="

    - name: Apply Performance Patches
      if: false
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        MIN_VERSION="5.16"
        cp "$KERNEL_PATCHES/common/optimized_mem_operations.patch" ./
        patch -p1 --forward < optimized_mem_operations.patch
        cp "$KERNEL_PATCHES/common/file_struct_8bytes_align.patch" ./
        patch -p1 --forward < file_struct_8bytes_align.patch
        cp "$KERNEL_PATCHES/common/reduce_cache_pressure.patch" ./
        patch -p1 --forward < reduce_cache_pressure.patch
        if [[ "$(printf '%s\n' "${{ inputs.kernel_version }}" "$MIN_VERSION" | sort -V | head -n1)" = "${{ inputs.kernel_version }}" ]]; then
          cp "$KERNEL_PATCHES/common/clear_page_16bytes_align.patch" ./
          patch -p1 --forward < clear_page_16bytes_align.patch
        else
          cp "$KERNEL_PATCHES/common/clear_page_16bytes_align.patch" ./
          sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' clear_page_16bytes_align.patch > clear_page_16bytes_align__pi.patch
          patch -p1 -F3 --forward < clear_page_16bytes_align__pi.patch
        fi

    - name: Add BBG
      if: true
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        curl -LSs https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
        echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
        sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig

    - name: Apply Module Check Bypass
      if: ${{ matrix.build_type == 'Bypass' || matrix.build_type == 'Hakan' }}
      run: |
        if [[ "${{ inputs.kernel_version }}" == "6.1" || "${{ inputs.kernel_version }}" == "6.6" || "${{ inputs.kernel_version }}" == "6.12" ]]; then
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module/version.c"
        else
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module.c"
        fi

        echo "Applying bypass to $TARGET_FILE"
        sed -i '/bad_version:/{:a;n;/return 0;/{s/return 0;/return 1;/;b};ba}' "$TARGET_FILE"

        # Verify the bypass
        if grep -A 5 "bad_version:" "$TARGET_FILE" | grep -q "return 1;"; then
          echo "SUCCESS: Module check bypass verified in $TARGET_FILE"
        else
          echo "FAILED: Module check bypass not found in $TARGET_FILE"
          grep -A 5 "bad_version:" "$TARGET_FILE" || true
          exit 1
        fi

    - name: Fix WiFi and Bluetooth on Samsung 6.6 GKI devices
      if: ${{ ( inputs.kernel_version == '6.6' ) }}
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        SYMBOL_LIST=android/abi_gki_aarch64_galaxy
        echo "kdp_set_cred_non_rcu" >> $SYMBOL_LIST
        echo "kdp_usecount_dec_and_test" >> $SYMBOL_LIST
        echo "kdp_usecount_inc" >> $SYMBOL_LIST

        PATCH="$KERNEL_PATCHES/samsung/min_kdp/add-min_kdp-symbols.patch"
        if patch -p1 --dry-run < "$PATCH"; then
          patch -p1 --no-backup-if-mismatch < $PATCH
        fi

        cp "$KERNEL_PATCHES/samsung/min_kdp/min_kdp.c" drivers/min_kdp.c
        echo "obj-y += min_kdp.o" >> drivers/Makefile

    - name: Fix WiFi and Bluetooth on Xiaomi 6.6 GKI devices
      if: ${{ ( inputs.kernel_version == '6.6' ) }}
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        SYMBOL_LIST=android/abi_gki_aarch64_xiaomi
        echo "device_find_any_child" >> $SYMBOL_LIST

    - name: Configure Kernel Options
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        cat >> "${{ env.DEFCONFIG }}" << 'EOF'
        # KernelSU Configuration
        CONFIG_KSU=y
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_UNICODE_FILTER=y

        # Mountify Support
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        
        # Networking Configuration
        CONFIG_IP_NF_TARGET_TTL=y
        CONFIG_IP6_NF_TARGET_HL=y
        CONFIG_IP6_NF_MATCH_HL=y
        
        # BBR TCP Congestion Control
        CONFIG_TCP_CONG_ADVANCED=y
        CONFIG_TCP_CONG_BBR=y
        CONFIG_NET_SCH_FQ=y
        CONFIG_TCP_CONG_BIC=n
        CONFIG_TCP_CONG_WESTWOOD=n
        CONFIG_TCP_CONG_HTCP=n
        
        # IPSet Support
        CONFIG_IP_SET=y
        CONFIG_IP_SET_MAX=65534
        CONFIG_IP_SET_BITMAP_IP=y
        CONFIG_IP_SET_BITMAP_IPMAC=y
        CONFIG_IP_SET_BITMAP_PORT=y
        CONFIG_IP_SET_HASH_IP=y
        CONFIG_IP_SET_HASH_IPMARK=y
        CONFIG_IP_SET_HASH_IPPORT=y
        CONFIG_IP_SET_HASH_IPPORTIP=y
        CONFIG_IP_SET_HASH_IPPORTNET=y
        CONFIG_IP_SET_HASH_IPMAC=y
        CONFIG_IP_SET_HASH_MAC=y
        CONFIG_IP_SET_HASH_NETPORTNET=y
        CONFIG_IP_SET_HASH_NET=y
        CONFIG_IP_SET_HASH_NETNET=y
        CONFIG_IP_SET_HASH_NETPORT=y
        CONFIG_IP_SET_HASH_NETIFACE=y
        CONFIG_IP_SET_LIST_SET=y

        # ZRAM/LZ4 Compression Support with LZ4K/LZ4KD (Option C implementation)
        CONFIG_ZSMALLOC=y
        CONFIG_ZRAM=y
        CONFIG_ZRAM_WRITEBACK=y
        CONFIG_CRYPTO_LZ4=y
        CONFIG_CRYPTO_LZ4HC=y
        CONFIG_CRYPTO_LZ4K=y
        CONFIG_CRYPTO_LZ4KD=y
        CONFIG_CRYPTO_842=y
        CONFIG_CRYPTO_LZ4K_OPLUS=y
        CONFIG_ZRAM_DEF_COMP_LZ4KD=y

        EOF

        # Ensure ZRAM and ZSMALLOC are built-in (not modules)
        sed -i 's/CONFIG_ZRAM=m/CONFIG_ZRAM=y/g' "${{ env.DEFCONFIG }}"
        sed -i 's/CONFIG_ZSMALLOC=m/CONFIG_ZSMALLOC=y/g' "${{ env.DEFCONFIG }}"

        echo "Checking if configs were applied..."
        if grep -q "CONFIG_KSU=y" "${{ env.DEFCONFIG }}" && grep -q "CONFIG_KSU_SUSFS=y" "${{ env.DEFCONFIG }}" && grep -q "CONFIG_KPROBES=y" "${{ env.DEFCONFIG }}"; then
          echo "SUCCESS: KSU, SUSFS, and KPROBES configs verified in ${{ env.DEFCONFIG }}"
        else
          echo "FAILED: KSU, SUSFS, or KPROBES configs missing in ${{ env.DEFCONFIG }}"
          # print last 50 lines to see what happened
          tail -n 50 "${{ env.DEFCONFIG }}"
          exit 1
        fi

        # Remove check_defconfig
        if [[ "${{ inputs.android_version }}" == "android16" && "${{ inputs.kernel_version }}" == "6.12" ]]; then
          sed -i '/name = "kernel_aarch64",/a\    check_defconfig = "disabled",' common/BUILD.bazel
          awk '/name = "kernel_aarch64"/,/^\)/ {if(/check_defconfig = "disabled"/) found=1} END{if(found) print "SUCCESS: check_defconfig = \"disabled\" is in the kernel_aarch64 block"; else print "FAILED: NOT in the kernel_aarch64 block"}' common/BUILD.bazel
        else
          sed -i 's/check_defconfig//' ./common/build.config.gki
        fi

        echo "Contents of ${{ env.DEFCONFIG }}:"
        cat "${{ env.DEFCONFIG }}"

    - name: Configure ReSukiSU-Specific Features
      if: inputs.ksu_variant == 'ReSuki'
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Adding ReSukiSU-specific configs ==="
        cat >> "${{ env.DEFCONFIG }}" << 'EOF'

        # ReSukiSU-specific Features
        CONFIG_KSU_MANUAL_SU=y
        CONFIG_KPM=y
        EOF
        echo "ReSukiSU features (Manual SU + KPM) enabled"

    - name: Configure Audio Modules
      if: inputs.variant == 'Hakan'
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        cat >> "${{ env.DEFCONFIG }}" << 'EOF'
        CONFIG_RFKILL=y
        CONFIG_CFG80211=y
        CONFIG_MAC80211=y
        EOF

        sed -i \
          -e '/_COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*"lib\/crypto\/libarc4\.ko",[[:space:]]*$/d}' \
          -e '/_COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*"net\/rfkill\/rfkill\.ko",[[:space:]]*$/d}' \
          common/modules.bzl

    - name: Configure SND
      if: inputs.variant == 'vTomsonek'
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        cat >> "${{ env.DEFCONFIG }}" << 'EOF'
        # Sound Configuration
        CONFIG_SND=y
        CONFIG_SND_DRIVERS=y
        CONFIG_SND_PCM=y
        CONFIG_SND_TIMER=y
        CONFIG_SND_DYNAMIC_MINORS=y
        CONFIG_SND_PROC_FS=y
        CONFIG_SND_ALOOP=m
        CONFIG_USB_GADGET=y
        CONFIG_CONFIGFS_FS=y
        CONFIG_USB_CONFIGFS=y
        CONFIG_USB_LIBCOMPOSITE=m
        CONFIG_USB_AUDIO=m
        CONFIG_USB_CONFIGFS_F_UAC1=y
        CONFIG_USB_CONFIGFS_F_UAC2=y
        EOF

        # Add snd-aloop.ko to modules list
        echo "drivers/usb/gadget/legacy/g_audio.ko" >> common/android/gki_aarch64_modules
        echo "sound/drivers/snd-aloop.ko" >> common/android/gki_aarch64_modules
        #echo "drivers/usb/gadget/libcomposite.ko" >> common/android/gki_aarch64_modules

        if [[ -f common/modules.bzl ]]; then
          # Insert before the closing bracket of COMMON_GKI_MODULES_LIST or _COMMON_GKI_MODULES_LIST
          echo "Audio modules injection: adding to module list"
          if [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "5.15" && $ACTUAL_SUBLEVEL -le 110 && "${{ inputs.os_patch_level }}" != "2023-09" ]] \
          || [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "6.1" && $ACTUAL_SUBLEVEL -le 25 && "${{ inputs.os_patch_level }}" != "2023-09" ]]; then
            # snd-aloop
            sed -i '/COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "sound/drivers/snd-aloop.ko",
            }' common/modules.bzl
            # USB Gadget Audio modules
            sed -i '/COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "drivers/usb/gadget/libcomposite.ko",
            }' common/modules.bzl
            sed -i '/COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "drivers/usb/gadget/legacy/g_audio.ko",
            }' common/modules.bzl
          else
            # snd-aloop
            sed -i '/_COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "sound/drivers/snd-aloop.ko",
            }' common/modules.bzl
            # USB Gadget Audio modules
            sed -i '/_COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "drivers/usb/gadget/libcomposite.ko",
            }' common/modules.bzl
            sed -i '/_COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "drivers/usb/gadget/legacy/g_audio.ko",
            }' common/modules.bzl
          fi
          
          # Verify the injection was successful
          if grep -q '"sound/drivers/snd-aloop.ko"' common/modules.bzl && \
            grep -q '"drivers/usb/gadget/libcomposite.ko"' common/modules.bzl && \
            grep -q '"drivers/usb/gadget/legacy/g_audio.ko"' common/modules.bzl && \
            grep -q '"drivers/usb/gadget/configfs.ko"' common/modules.bzl; then
            echo " Audio modules injection: successfully added all modules to list"
          else
            echo " Audio modules injection: failed to add one or more modules"
            exit 1
          fi
        fi

        # Add symbols to abi_gki_aarch64
        #SYMBOL_LIST=common/android/abi_gki_aarch64
        #cat Wild_KSU/kernel/export_symbol.txt | awk '{sub("[ \t]+","");print "  "$0}' >> $SYMBOL_LIST

        # ABI compare bypass per kernel/android version
        # Edit each block as needed per version
        if [[ "${{ inputs.android_version }}" == "android12" && "${{ inputs.kernel_version }}" == "5.10" ]]; then
          sed -i 's/^\s*exit 1$/    echo "Who Cares? Bypassing Now!"/' build/abi/compare_to_symbol_list
        elif [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.10" ]]; then
          sed -i 's/^\s*exit 1$/    echo "Who Cares? Bypassing Now!"/' build/kernel/abi/compare_to_symbol_list
        elif [[ "${{ inputs.android_version }}" == "android13" && "${{ inputs.kernel_version }}" == "5.15" ]]; then
          sed -i 's/^\s*exit 1$/    echo "Who Cares? Bypassing Now!"/' build/kernel/abi/compare_to_symbol_list
        elif [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "5.15" ]]; then
          perl -i -pe 's/^(\s*)return 1$/$1print("Who Cares? Bypassing Now!")\n$1return 0/g if /if missing_symbols:/../return 1/' build/kernel/abi/check_buildtime_symbol_protection.py
        elif [[ "${{ inputs.android_version }}" == "android14" && "${{ inputs.kernel_version }}" == "6.1" ]]; then
          perl -i -pe 's/^(\s*)return 1$/$1print("Who Cares? Bypassing Now!")\n$1return 0/g if /if missing_symbols:/../return 1/' build/kernel/abi/check_buildtime_symbol_protection.py
        elif [[ "${{ inputs.android_version }}" == "android15" && "${{ inputs.kernel_version }}" == "6.6" ]]; then
          perl -i -pe 's/^(\s*)return 1$/$1print("Who Cares? Bypassing Now!")\n$1return 0/g if /if missing_symbols:/../return 1/' build/kernel/abi/check_buildtime_symbol_protection.py
        fi

    - name: Append ashmem exports if missing
      if: ${{ inputs.android_version == 'android16' && inputs.kernel_version == '6.12' }}
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        FILE=common/drivers/staging/android/ashmem.c
        if [[ -f "$FILE" ]] && ! grep -q 'is_ashmem_file' "$FILE"; then
        cat >>"$FILE" <<'EOF'
        bool is_ashmem_file(struct file *file) { return false; }
        int ashmem_area_name(struct file *file, char *name) { return 0; }
        long ashmem_area_size(struct file *file) { return 0; }
        struct file *ashmem_area_vmfile(struct file *file) { return NULL; }
        EXPORT_SYMBOL_GPL(is_ashmem_file);
        EXPORT_SYMBOL_GPL(ashmem_area_name);
        EXPORT_SYMBOL_GPL(ashmem_area_size);
        EXPORT_SYMBOL_GPL(ashmem_area_vmfile);
        EOF
        fi

        if [ -f common/drivers/android/binder/Makefile ]; then
          perl -i -0777 -pe 's/\$\(\s*CONFIG_ANDROID_BINDER_IPC_RUST\s*\)/m/' common/drivers/android/binder/Makefile
          #perl -i -ne 'print unless /CONFIG_ANDROID_BINDER_IPC_RUST_DUMMY/' common/drivers/android/binder/Makefile
          perl -i -pe 's/^rust_binder-\$\([^)]+\)\s*:=/rust_binder-y :=/' common/drivers/android/binder/Makefile
          cat common/drivers/android/Makefile
          cat common/drivers/android/binder/Makefile
          #perl -ni -e 'print unless /rust_toolchain\s*=\s*"\/\/build\/rust:linux_kernel_toolchain",/' common/BUILD.bazel
          #cat common/BUILD.bazel
          rustup set profile minimal
          rustup update nightly
          rustup default nightly
          rustup target add aarch64-unknown-none
        else
          perl -i -0777 -pe 's/\$\(\s*CONFIG_ANDROID_BINDER_IPC_RUST\s*\)/m/' common/drivers/android/Makefile
          cat common/drivers/android/Makefile
        fi

    - name: Clean Build Flags
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        # Keep kernel version completely stock - no suffix modifications
        # Only remove dirty flag and ABI exports for clean build
        if [ -f "build/build.sh" ]; then
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
        else
          sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" ./build/kernel/kleaf/impl/stamp.bzl
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
          rm -rf ./common/android/abi_gki_protected_exports_*
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' ./common/BUILD.bazel
        fi

        cd $KERNEL_ROOT/common
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Clean build flags" || true

    - name: Set Stock Build Identity
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Setting Stock Build Identity ==="

        # Use Google's standard GKI build identity
        STOCK_BUILD_USER="build-user"
        STOCK_BUILD_HOST="build-host"

        # Get stock timestamp from os_patch_level (format: YYYY-MM)
        # Convert to a realistic stock build date (15th of the month, 12:00:00 UTC)
        PATCH_YEAR=$(echo "${{ inputs.os_patch_level }}" | cut -d'-' -f1)
        PATCH_MONTH=$(echo "${{ inputs.os_patch_level }}" | cut -d'-' -f2)

        # Calculate day of week for the 15th of that month
        STOCK_DATE="${PATCH_YEAR}-${PATCH_MONTH}-15 12:00:00 UTC"
        STOCK_TIMESTAMP=$(date -d "$STOCK_DATE" "+%a %b %d %H:%M:%S UTC %Y" 2>/dev/null || date -u "+%a %b %d %H:%M:%S UTC %Y")
        STOCK_VERSION_STRING="#1 SMP PREEMPT $STOCK_TIMESTAMP"

        echo "Stock identity: $STOCK_VERSION_STRING"
        echo "Build user: $STOCK_BUILD_USER"
        echo "Build host: $STOCK_BUILD_HOST"

        # Method 1: Patch mkcompile_h for older kernels (5.x, 6.1)
        if [ -f "scripts/mkcompile_h" ]; then
          echo "Patching scripts/mkcompile_h..."

          # Set UTS_VERSION to stock timestamp
          sed -i "s|UTS_VERSION=.*|UTS_VERSION=\"$STOCK_VERSION_STRING\"|" scripts/mkcompile_h

          # Set build user and host
          if grep -q "LINUX_COMPILE_BY=" scripts/mkcompile_h; then
            sed -i "s|LINUX_COMPILE_BY=.*|LINUX_COMPILE_BY=\"$STOCK_BUILD_USER\"|" scripts/mkcompile_h
            sed -i "s|LINUX_COMPILE_HOST=.*|LINUX_COMPILE_HOST=\"$STOCK_BUILD_HOST\"|" scripts/mkcompile_h
          fi
        fi

        # Method 2: Patch init/Makefile for newer kernels (6.6+)
        if [ -f "init/Makefile" ] && grep -q "build-timestamp" init/Makefile; then
          echo "Patching init/Makefile for kernel 6.x..."
          sed -i "s|build-timestamp = .*|build-timestamp = \"$STOCK_TIMESTAMP\"|" init/Makefile
        fi

        # Method 3: Export KBUILD variables (backup)
        echo "KBUILD_BUILD_TIMESTAMP=$STOCK_TIMESTAMP" >> $GITHUB_ENV
        echo "KBUILD_BUILD_USER=$STOCK_BUILD_USER" >> $GITHUB_ENV
        echo "KBUILD_BUILD_HOST=$STOCK_BUILD_HOST" >> $GITHUB_ENV

        echo "=== Stock build identity set ==="

    - name: Build Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        set -ex
        if [ -f "build/build.sh" ]; then
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh || exit 1
        else
          # Always use --lto=thin for bootable kernels (lto=none causes boot failures on android15+)
          tools/bazel build --config=fast --config=stamp --lto=thin //common:kernel_aarch64_dist || exit 1
        fi

    - name: Prepare AnyKernel3 Zip
      run: |
        # Copy Image from normal build locations
        if [ -f "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" ]; then
          cp "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" "$ANYKERNEL3/Image"
        elif [ -f "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" ]; then
          cp "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" "$ANYKERNEL3/Image"
        else
          echo "Error: Image file not found in any expected location"
          exit 1
        fi

    - name: Create KSU ZRAM Module
      if: inputs.android_version == 'android12' && inputs.kernel_version == '5.10'  # RE-ENABLED - boot failure was Unicode Filter, not ZRAM
      run: |
        echo "Creating KSU module for ZRAM auto-configuration..."

        # Create KSU module directory structure
        ZRAM_MODULE="$ANYKERNEL3/modules/data/adb/modules/zram_config"
        mkdir -p "$ZRAM_MODULE"

        # Create module.prop
        cat > "$ZRAM_MODULE/module.prop" << 'MODPROP'
        id=zram_config
        name=ZRAM 8GB LZ4 Configuration
        version=1.0
        versionCode=1
        author=Enginex0
        description=Configures ZRAM with 8GB size and LZ4 compression at boot. Compatible with Magisk/KernelSU.
        MODPROP
        sed -i 's/^        //' "$ZRAM_MODULE/module.prop"

        # Create service.sh (runs at boot after zygote)
        cat > "$ZRAM_MODULE/service.sh" << 'SERVICESH'
        #!/system/bin/sh
        # ZRAM 8GB LZ4 Configuration
        # Author: Enginex0

        MODDIR=${0%/*}
        LOG="$MODDIR/zram.log"

        log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG"
        }

        # Configuration
        ZRAM_SIZE=8589934592  # 8GB in bytes
        ZRAM_ALGO=lz4
        MAX_STREAMS=8

        log "========================================="
        log "=== ZRAM Configuration Service Start ==="
        log "========================================="

        # Wait for system to stabilize
        log "Waiting for system initialization..."
        sleep 30

        # Stop existing ZRAM
        log "Stopping existing ZRAM swap..."
        swapoff /dev/block/zram0 2>/dev/null
        sleep 2

        # Reset ZRAM
        log "Resetting ZRAM device..."
        echo 1 > /sys/block/zram0/reset 2>/dev/null
        sleep 1

        # Set compression streams
        log "Setting max_comp_streams: $MAX_STREAMS"
        echo "$MAX_STREAMS" > /sys/block/zram0/max_comp_streams 2>/dev/null

        # Set compression algorithm
        log "Setting compression algorithm: $ZRAM_ALGO"
        echo "$ZRAM_ALGO" > /sys/block/zram0/comp_algorithm 2>/dev/null

        # Set disk size
        log "Setting disksize: $ZRAM_SIZE bytes (8GB)"
        echo "$ZRAM_SIZE" > /sys/block/zram0/disksize 2>/dev/null

        # Initialize swap
        log "Initializing swap partition..."
        mkswap /dev/block/zram0 > /dev/null 2>&1

        log "Enabling swap..."
        swapon /dev/block/zram0 > /dev/null 2>&1

        # Verify configuration
        ACTUAL_SIZE=$(cat /sys/block/zram0/disksize 2>/dev/null)
        ACTUAL_ALGO=$(cat /sys/block/zram0/comp_algorithm 2>/dev/null | grep -o '\[.*\]' | tr -d '[]')
        [ -z "$ACTUAL_ALGO" ] && ACTUAL_ALGO=$(cat /sys/block/zram0/comp_algorithm 2>/dev/null)

        log "----------------------------------------"
        log "ZRAM Configuration Result:"
        log "  Size: $ACTUAL_SIZE bytes"
        log "  Algorithm: $ACTUAL_ALGO"
        log "----------------------------------------"

        # Log memory status
        MEM_INFO=$(free -h 2>/dev/null | grep -E "Mem:|Swap:")
        log "Memory Status:"
        log "$MEM_INFO"

        log "=== ZRAM Configuration Complete ==="
        SERVICESH
        sed -i 's/^        //' "$ZRAM_MODULE/service.sh"
        chmod +x "$ZRAM_MODULE/service.sh"

        # Create customize.sh
        cat > "$ZRAM_MODULE/customize.sh" << 'CUSTOMIZESH'
        #!/system/bin/sh
        # ZRAM 8GB Module Installation Script

        ui_print "========================================="
        ui_print "   ZRAM 8GB LZ4 Configuration Module"
        ui_print "   Author: Enginex0"
        ui_print "========================================="
        ui_print ""
        ui_print "Configuration:"
        ui_print "  - ZRAM Size: 8GB"
        ui_print "  - Algorithm: LZ4"
        ui_print "  - Streams: 8"
        ui_print ""
        ui_print "The module will configure ZRAM at boot."
        ui_print ""

        # Set permissions
        set_perm_recursive $MODPATH 0 0 0755 0644
        set_perm $MODPATH/service.sh 0 0 0755
        CUSTOMIZESH
        sed -i 's/^        //' "$ZRAM_MODULE/customize.sh"
        chmod +x "$ZRAM_MODULE/customize.sh"

        # Create META-INF structure
        mkdir -p "$ZRAM_MODULE/META-INF/com/google/android"

        # Create updater-script
        echo '#MAGISK' > "$ZRAM_MODULE/META-INF/com/google/android/updater-script"

        # Create update-binary
        cat > "$ZRAM_MODULE/META-INF/com/google/android/update-binary" << 'UPDATEBIN'
        #!/sbin/sh

        #################
        # Initialization
        #################

        umask 022

        # Global vars
        TMPDIR=/dev/tmp
        PERSISTDIR=/sbin/.magisk/mirror/persist

        rm -rf $TMPDIR 2>/dev/null
        mkdir -p $TMPDIR

        # Echo before loading util_functions
        ui_print() { echo "$1"; }

        require_new_magisk() {
          ui_print "*******************************"
          ui_print " Please install Magisk v20.4+! "
          ui_print "*******************************"
          exit 1
        }

        ##############
        # Environment
        ##############

        OUTFD=$2
        ZIPFILE=$3

        mount /data 2>/dev/null

        # Load utility functions
        [ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
        . /data/adb/magisk/util_functions.sh
        [ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk

        # Prep flash
        setup_flashable

        # Mount partitions
        mount_partitions

        # Detect version and architecture
        api_level_arch_detect

        # Setup busybox and binaries
        $BOOTMODE && boot_actions || recovery_actions

        ##############
        # Preparation
        ##############

        # Extract prop file
        unzip -o "$ZIPFILE" module.prop -d $TMPDIR >&2
        [ ! -f $TMPDIR/module.prop ] && abort "! Unable to extract zip file!"

        $BOOTMODE && MODDIRNAME=modules_update || MODDIRNAME=modules
        MODULEROOT=$NVBASE/$MODDIRNAME
        MODID=$(grep_prop id $TMPDIR/module.prop)
        MODPATH=$MODULEROOT/$MODID

        # Create mod paths
        rm -rf $MODPATH 2>/dev/null
        mkdir -p $MODPATH

        ##########
        # Install
        ##########

        ui_print "- Extracting module files"
        unzip -o "$ZIPFILE" -d $MODPATH >&2

        # Remove placeholder
        rm -f $MODPATH/META-INF/com/google/android/updater-script
        rm -rf $MODPATH/META-INF 2>/dev/null

        # Set permissions
        set_perm_recursive $MODPATH 0 0 0755 0644
        [ -f $MODPATH/service.sh ] && set_perm $MODPATH/service.sh 0 0 0755

        # Handle replace folders
        for TARGET in $REPLACE; do
          ui_print "- Replace target: $TARGET"
          mktouch $MODPATH$TARGET/.replace
        done

        $BOOTMODE && {
          # Update info for Magisk Manager
          mktouch $NVBASE/modules/$MODID/update
          cp -af $MODPATH/module.prop $NVBASE/modules/$MODID/module.prop
        }

        # Copy over custom sepolicy rules
        [ -f $MODPATH/sepolicy.rule ] && {
          ui_print "- Installing custom sepolicy rules"
          copy_sepolicy_rules
        }

        ##############
        # Finalizing
        ##############

        cd /
        $BOOTMODE || recovery_cleanup
        rm -rf $TMPDIR

        ui_print "- Done"
        exit 0
        UPDATEBIN
        sed -i 's/^        //' "$ZRAM_MODULE/META-INF/com/google/android/update-binary"
        chmod +x "$ZRAM_MODULE/META-INF/com/google/android/update-binary"

        echo "KSU ZRAM module created at: $ZRAM_MODULE (exact replica of standalone)"

    - name: Copy snd-aloop module
      if: ${{ inputs.variant == 'vTomsonek' }}
      run: |
        if [ "${{ inputs.variant }}" = "vTomsonek" ]; then
          sed -i 's|^do\.modules=.*|do.modules=1|' ./AnyKernel3/anykernel.sh
        fi

        mkdir -p AnyKernel3/modules/data/adb/lkm

        if [[ "${{ inputs.android_version }}" == "android12" || "${{ inputs.android_version }}" == "android13" ]]; then
          SRC_DIR="$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist"
        else
          SRC_DIR="$KERNEL_ROOT/bazel-bin/common/kernel_aarch64"
        fi

        cp "$SRC_DIR/snd-aloop.ko" "$ANYKERNEL3/modules/data/adb/lkm/"
        cp "$SRC_DIR/g_audio.ko" "$ANYKERNEL3/modules/data/adb/lkm/"

    - name: Scan and collect patch rejects
      if: ${{ always() }}
      run: |
        set -e
        CONFIG_DIR="$KERNEL_ROOT"
        REJECTS_DIR="$GITHUB_WORKSPACE/patch-rejects"
        mkdir -p "$REJECTS_DIR"
        # Find all .rej files under the configuration directory
        mapfile -t REJS < <(find "$CONFIG_DIR" -type f -name '*.rej')
        REJ_COUNT=${#REJS[@]}
        echo "Found $REJ_COUNT .rej files under $CONFIG_DIR"
        echo "REJ_COUNT=$REJ_COUNT" >> $GITHUB_ENV
        if [ "$REJ_COUNT" -gt 0 ]; then
          for REJ in "${REJS[@]}"; do
            # Relative path from $CONFIG
            REL="${REJ#"$CONFIG_DIR"/}"
            DEST="$REJECTS_DIR/$REL"
            mkdir -p "$(dirname "$DEST")"
            cp "$REJ" "$DEST"
            # Copy the associated original file alongside the .rej
            ORIG="${REJ%.rej}"
            if [ -f "$ORIG" ]; then
              ORIG_DEST="$REJECTS_DIR/${REL%.rej}"
              mkdir -p "$(dirname "$ORIG_DEST")"
              cp "$ORIG" "$ORIG_DEST"
            fi
            echo "$REL" >> "$REJECTS_DIR/index.txt"
          done
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-AnyKernel3
        path: ./AnyKernel3/**
        if-no-files-found: ignore
        compression-level: 9

    - name: Upload Rejects
      if: ${{ always() && matrix.build_type != 'Bypass' && env.REJ_COUNT > 0 }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-Rejects
        path: patch-rejects/
        if-no-files-found: ignore
        compression-level: 9

# End of workflow
